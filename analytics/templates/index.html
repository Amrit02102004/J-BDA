<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/jquery.dataTables.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --light-bg: #f8f9fa;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: var(--card-shadow);
        }
        
        .analysis-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .analysis-card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(to right, var(--info), var(--primary));
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .upload-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }
        
        .sidebar {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 20px;
        }
        
        .analysis-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: none;
            background-color: var(--light-bg);
            transition: all 0.2s;
            color: #495057;
        }
        
        .analysis-btn:hover {
            background-color: var(--info);
            color: white;
        }
        
        .analysis-btn i {
            margin-right: 10px;
        }
        
        /* JSON Viewer Styles */
        .json-container {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            max-height: 500px;
            overflow: auto;
        }
        
        .json-key {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .json-value {
            color: #1b6ec2;
        }
        
        .json-string {
            color: #38b000;
        }
        
        .json-number {
            color: #9d4edd;
        }
        
        .json-boolean {
            color: #ff9e00;
        }
        
        .json-null {
            color: #6c757d;
        }
        
        .collapsible {
            cursor: pointer;
        }
        
        .collapsible:before {
            content: 'â–¼';
            margin-right: 5px;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .collapsed:before {
            transform: rotate(-90deg);
        }
        
        .json-children {
            padding-left: 20px;
            border-left: 1px dashed #ced4da;
        }
        
        /* DataTables customization */
        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter, 
        .dataTables_wrapper .dataTables_info, 
        .dataTables_wrapper .dataTables_processing, 
        .dataTables_wrapper .dataTables_paginate {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: var(--primary);
            color: white !important;
            border: none;
        }
        
        /* Charts */
        .chart-container {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
        
        /* Loading spinner */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            border-radius: 10px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line me-2"></i>Data Analysis Dashboard</h1>
                    <p class="mb-0">Upload your dataset and explore insights</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="badge bg-light text-dark p-2">
                        <i class="fas fa-clock me-1"></i> <span id="currentDateTime">Loading...</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 mb-4">
                <div class="sidebar">
                    <div class="upload-container mb-3">
                        <h5><i class="fas fa-file-upload me-2"></i>Upload Dataset</h5>
                        <div class="input-group mb-3">
                            <input type="file" class="form-control" id="fileInput">
                            <button class="btn btn-primary" type="button" onclick="uploadFile()">Upload</button>
                        </div>
                        <div id="uploadMessage" class="mt-2 small"></div>
                    </div>
                    
                    <h5><i class="fas fa-sliders-h me-2"></i>Analysis Options</h5>
                    <button class="analysis-btn" onclick="fetchData('overview')">
                        <i class="fas fa-table"></i> Dataset Overview
                    </button>
                    <button class="analysis-btn" onclick="fetchData('basic-stats')">
                        <i class="fas fa-calculator"></i> Basic Statistics
                    </button>
                    <button class="analysis-btn" onclick="fetchData('numerical-analysis')">
                        <i class="fas fa-sort-numeric-up"></i> Numerical Analysis
                    </button>
                    <button class="analysis-btn" onclick="fetchData('categorical-analysis')">
                        <i class="fas fa-tags"></i> Categorical Analysis
                    </button>
                    <button class="analysis-btn" onclick="fetchData('correlation-analysis')">
                        <i class="fas fa-project-diagram"></i> Correlation Analysis
                    </button>
                    <button class="analysis-btn" onclick="fetchData('data-integrity')">
                        <i class="fas fa-shield-alt"></i> Data Integrity
                    </button>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <div class="analysis-card">
                    <div class="card-header">
                        <span id="resultTitle">Results</span>
                        <div>
                            <button class="btn btn-sm btn-light" id="exportBtn" style="display: none;">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card-body position-relative">
                        <div id="resultsContainer">
                            <div class="text-center py-5">
                                <i class="fas fa-arrow-left fa-2x mb-3 text-muted"></i>
                                <h5>Choose an analysis option</h5>
                                <p class="text-muted">Upload a dataset and select an analysis option from the sidebar to get started.</p>
                            </div>
                        </div>
                        
                        <!-- For charts -->
                        <div class="chart-container" style="display: none;">
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    
    <script>
        const BASE_URL = "http://127.0.0.1:8000/api";
        let currentEndpoint = null;

        // Update current date and time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent = now.toLocaleString();
        }
        
        updateDateTime();
        setInterval(updateDateTime, 60000);

        // Upload File
        function uploadFile() {
            let fileInput = document.getElementById("fileInput").files[0];
            let messageDiv = document.getElementById("uploadMessage");
            
            if (!fileInput) {
                messageDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Please select a file to upload.</span>`;
                return;
            }
            
            // Show loading state
            messageDiv.innerHTML = `<span class="text-primary"><i class="fas fa-spinner fa-spin me-1"></i>Uploading file...</span>`;
            
            let formData = new FormData();
            formData.append("file", fileInput);
            
            fetch(`${BASE_URL}/upload/`, {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("Upload Response:", data);
                
                if (data.message) {
                    messageDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>${data.message} (${data.rows} rows)</span>`;
                } else if (data.error) {
                    messageDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>${data.error}</span>`;
                }
            })
            .catch(error => {
                console.error("Error uploading file:", error);
                messageDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>Error uploading file. Please try again.</span>`;
            });
        }

        // Fetch Analysis Data
        function fetchData(endpoint) {
            currentEndpoint = endpoint;
            
            // Update result title based on endpoint
            const titleMapping = {
                'overview': 'Dataset Overview',
                'basic-stats': 'Basic Statistics',
                'numerical-analysis': 'Numerical Analysis',
                'categorical-analysis': 'Categorical Analysis',
                'correlation-analysis': 'Correlation Analysis',
                'data-integrity': 'Data Integrity'
            };
            
            document.getElementById('resultTitle').textContent = titleMapping[endpoint] || 'Results';
            
            // Show loading spinner
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading ${titleMapping[endpoint]}...</p>
                </div>
            `;
            
            // Hide chart container
            document.querySelector('.chart-container').style.display = 'none';
            
            fetch(`${BASE_URL}/${endpoint}/`)
                .then(response => response.json())
                .then(data => {
                    console.log(`API Response for ${endpoint}:`, data);
                    
                    if (!data || Object.keys(data).length === 0 || (Array.isArray(data) && data.length === 0)) {
                        resultsContainer.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>No data available.
                            </div>
                        `;
                        return;
                    }
                    
                    // Show export button
                    document.getElementById('exportBtn').style.display = 'block';
                    
                    // Process data based on endpoint
                    if (endpoint === "overview") {
                        displayOverview(data);
                    } else if (endpoint === "basic-stats") {
                        displayBasicStats(data);
                    } else if (endpoint === "numerical-analysis") {
                        displayNumericalAnalysis(data);
                    } else if (endpoint === "categorical-analysis") {
                        displayCategoricalAnalysis(data);
                    } else if (endpoint === "correlation-analysis") {
                        displayCorrelationAnalysis(data);
                    } else if (endpoint === "data-integrity") {
                        displayDataIntegrity(data);
                    } else {
                        // Default: Display as JSON
                        resultsContainer.innerHTML = '';
                        resultsContainer.appendChild(createJsonViewer(data));
                    }
                })
                .catch(error => {
                    console.error(`Error fetching data for ${endpoint}:`, error);
                    resultsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>Error fetching data.
                            <hr>
                            <small>${error.message}</small>
                        </div>
                    `;
                });
        }

        // Display Dataset Overview
        function displayOverview(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            // Dataset shape info
            const shapeCard = document.createElement('div');
            shapeCard.className = 'mb-4';
            shapeCard.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="bg-light rounded p-3 text-center">
                            <h1 class="display-4 text-primary">${data.shape?.[0] || 'N/A'}</h1>
                            <p class="text-muted mb-0">Rows</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded p-3 text-center">
                            <h1 class="display-4 text-primary">${data.shape?.[1] || 'N/A'}</h1>
                            <p class="text-muted mb-0">Columns</p>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(shapeCard);
            
            // Column list card
            if (data.columns && data.columns.length > 0) {
                const columnsCard = document.createElement('div');
                columnsCard.className = 'mb-4';
                columnsCard.innerHTML = `
                    <h5><i class="fas fa-columns me-2"></i>Columns</h5>
                    <div class="row row-cols-1 row-cols-md-3 g-3">
                        ${data.columns.map(col => `
                            <div class="col">
                                <div class="bg-light rounded p-2">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-tag text-primary"></i>
                                        </div>
                                        <div class="flex-grow-1 ms-3 text-truncate" title="${col}">
                                            ${col}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                resultsContainer.appendChild(columnsCard);
            }
            
            // Sample data table
            if (data.head && data.head.length > 0) {
                const sampleDataCard = document.createElement('div');
                sampleDataCard.className = 'mb-4';
                sampleDataCard.innerHTML = `<h5><i class="fas fa-table me-2"></i>Sample Data (First 5 rows)</h5>`;
                
                const tableDiv = document.createElement('div');
                tableDiv.className = 'table-responsive';
                
                const table = document.createElement('table');
                table.id = 'sampleDataTable';
                table.className = 'table table-striped table-hover';
                
                // Create table headers
                let headers = Object.keys(data.head[0]);
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                
                data.head.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.textContent = row[header] !== undefined ? row[header] : '-';
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
                
                table.appendChild(tbody);
                tableDiv.appendChild(table);
                sampleDataCard.appendChild(tableDiv);
                resultsContainer.appendChild(sampleDataCard);
                
                // Initialize DataTable
                $('#sampleDataTable').DataTable({
                    paging: false,
                    searching: false,
                    info: false
                });
            }
        }

        // Display Basic Statistics
        function displayBasicStats(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            // Create row for cards
            const row = document.createElement('div');
            row.className = 'row';
            
            // Add each statistic as a card
            const statCards = [
                { title: 'Non-Null Count', data: data.non_null_count, icon: 'fa-check-circle' },
                { title: 'Unique Values', data: data.unique_values, icon: 'fa-fingerprint' },
                { title: 'Missing Values', data: data.missing_values, icon: 'fa-exclamation-triangle' },
                { title: 'Missing Percentage', data: data.missing_percentage, icon: 'fa-percentage' }
            ];
            
            statCards.forEach(statCard => {
                if (statCard.data) {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 mb-4';
                    card.innerHTML = `
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <i class="fas ${statCard.icon} me-2"></i>${statCard.title}
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>Column</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(statCard.data).map(([column, value]) => `
                                                <tr>
                                                    <td>${column}</td>
                                                    <td>${typeof value === 'number' ? (statCard.title === 'Missing Percentage' ? value.toFixed(2) + '%' : value) : value}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    row.appendChild(card);
                }
            });
            
            resultsContainer.appendChild(row);
        }

        // Display Numerical Analysis
        function displayNumericalAnalysis(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            // Extract the descriptive statistics
            const statsOrder = ['count', 'mean', 'std', 'min', '25%', '50%', '75%', 'max', 'variance'];
            const statsNames = {
                'count': 'Count', 
                'mean': 'Mean', 
                'std': 'Standard Deviation', 
                'min': 'Minimum',
                '25%': '25th Percentile',
                '50%': 'Median',
                '75%': '75th Percentile',
                'max': 'Maximum',
                'variance': 'Variance'
            };
            
            const statsCards = statsOrder.map(stat => {
                if (data[stat]) {
                    return {
                        title: statsNames[stat],
                        data: data[stat]
                    };
                }
                return null;
            }).filter(Boolean);
            
            // Create visualization for each stat
            statsCards.forEach(statCard => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'mb-4';
                cardDiv.innerHTML = `
                    <h5>${statCard.title}</h5>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Value</th>
                                    <th>Visualization</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(statCard.data).map(([column, value]) => {
                                    // Create a relative bar visualization
                                    const maxValue = Math.max(...Object.values(statCard.data).map(v => parseFloat(v) || 0));
                                    const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                                    
                                    return `
                                        <tr>
                                            <td>${column}</td>
                                            <td>${typeof value === 'number' ? value.toFixed(4) : value}</td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar bg-info" role="progressbar" 
                                                         style="width: ${percentage}%;" 
                                                         aria-valuenow="${value}" 
                                                         aria-valuemin="0" 
                                                         aria-valuemax="${maxValue}">
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                resultsContainer.appendChild(cardDiv);
            });
        }

        // Display Categorical Analysis
        function displayCategoricalAnalysis(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<h5>Categorical Columns Analysis</h5>';
            
            // For each categorical column
            Object.entries(data).forEach(([column, stats]) => {
                const colCard = document.createElement('div');
                colCard.className = 'card mb-4';
                colCard.innerHTML = `
                    <div class="card-header bg-light">
                        <i class="fas fa-tag me-2"></i>${column}
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Unique Values:</strong> ${stats.unique_values}</p>
                                <p><strong>Most Frequent Value:</strong> ${stats.most_frequent || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(colCard);
            });
        }

        // Display Correlation Analysis
        function displayCorrelationAnalysis(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            // Create a correlation matrix visualization
            if (data.correlation_matrix) {
                // Extract features and create matrix
                const features = Object.keys(data.correlation_matrix);
                
                const matrixTable = document.createElement('div');
                matrixTable.className = 'table-responsive';
                matrixTable.innerHTML = `
                    <table class="table table-bordered table-sm correlation-matrix">
                        <thead>
                            <tr>
                                <th></th>
                                ${features.map(f => `<th>${f}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${features.map(row => `
                                <tr>
                                    <th>${row}</th>
                                    ${features.map(col => {
                                        const value = data.correlation_matrix[row][col];
                                        const normalized = (value + 1) / 2;  // Normalize correlation (-1 to 1) to (0 to 1)
                                        const color = getCorrelationColor(normalized);
                                        return `<td style="background-color: ${color};">${value?.toFixed(2) || 'N/A'}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Add color legend
                const legend = document.createElement('div');
                legend.className = 'mt-3 d-flex align-items-center';
                legend.innerHTML = `
                    <span>-1</span>
                    <div class="mx-2 flex-grow-1" style="height: 20px; background: linear-gradient(to right, #ff7675, #ffffff, #55efc4);"></div>
                    <span>+1</span>
                `;
                
                const matrixCard = document.createElement('div');
                matrixCard.className = 'mb-4';
                matrixCard.innerHTML = '<h5><i class="fas fa-project-diagram me-2"></i>Correlation Matrix</h5>';
                matrixCard.appendChild(matrixTable);
                matrixCard.appendChild(legend);
                resultsContainer.appendChild(matrixCard);
                
                // Also create a chart visualization
                document.querySelector('.chart-container').style.display = 'block';
                createCorrelationChart(data.correlation_matrix);
            } else {
                // Direct correlation data (not nested in correlation_matrix)
                const matrixTable = document.createElement('div');
                matrixTable.className = 'table-responsive';
                
                // Get all features
                const features = Object.keys(data);
                
                matrixTable.innerHTML = `
                    <table class="table table-bordered table-sm correlation-matrix">
                        <thead>
                            <tr>
                                <th></th>
                                ${features.map(f => `<th>${f}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${features.map(row => `
                                <tr>
                                    <th>${row}</th>
                                    ${features.map(col => {
                                        const value = data[row][col];
                                        const normalized = (value + 1) / 2;  // Normalize correlation (-1 to 1) to (0 to 1)
                                        const color = getCorrelationColor(normalized);
                                        return `<td style="background-color: ${color};">${value?.toFixed(2) || 'N/A'}</td>`;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Add color legend
                const legend = document.createElement('div');
                legend.className = 'mt-3 d-flex align-items-center';
                legend.innerHTML = `
                    <span>-1</span>
                    <div class="mx-2 flex-grow-1" style="height: 20px; background: linear-gradient(to right, #ff7675, #ffffff, #55efc4);"></div>
                    <span>+1</span>
                `;
                
                const matrixCard = document.createElement('div');
                matrixCard.className = 'mb-4';
                matrixCard.innerHTML = '<h5><i class="fas fa-project-diagram me-2"></i>Correlation Matrix</h5>';
                matrixCard.appendChild(matrixTable);
                matrixCard.appendChild(legend);
                resultsContainer.appendChild(matrixCard);
                
                // Also create a chart visualization
                document.querySelector('.chart-container').style.display = 'block';
                createCorrelationChart(data);
            }
        }

        // Display Data Integrity
        function displayDataIntegrity(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            
            // Create a summary card
            const summaryCard = document.createElement('div');
            summaryCard.className = 'card mb-4';
            summaryCard.innerHTML = `
                <div class="card-header">
                    <i class="fas fa-shield-alt me-2"></i>Data Integrity Summary
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert ${data.duplicate_rows > 0 ? 'alert-warning' : 'alert-success'}">
                                <h5><i class="fas fa-copy me-2"></i>Duplicate Rows</h5>
                                <p class="mb-0">${data.duplicate_rows} duplicate rows found</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(summaryCard);
            
            // Create inconsistent value types card
            if (data.inconsistent_values) {
                const inconsistentCard = document.createElement('div');
                inconsistentCard.className = 'card mb-4';
                inconsistentCard.innerHTML = `
                    <div class="card-header">
                        <i class="fas fa-exclamation-triangle me-2"></i>Inconsistent Value Types
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Column</th>
                                        <th>Number of Different Types</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data.inconsistent_values).map(([column, typeCount]) => `
                                        <tr>
                                            <td>${column}</td>
                                            <td>${typeCount}</td>
                                            <td>
                                                ${typeCount > 1 ? 
                                                    `<span class="badge bg-warning">Inconsistent</span>` : 
                                                    `<span class="badge bg-success">Consistent</span>`}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(inconsistentCard);
            }
        }

        // Helper function to get color for correlation value
        function getCorrelationColor(value) {
            // Create a color gradient for correlation values
            // -1 (red) to 0 (white) to 1 (green)
            if (value < 0.5) {
                // -1 to 0 : red to white
                const intensity = Math.round(255 * (value * 2));
                return `rgba(255, ${intensity}, ${intensity}, 0.8)`;
            } else {
                // 0 to 1 : white to green
                const intensity = Math.round(255 * (2 - value * 2));
                return `rgba(${intensity}, 255, ${intensity}, 0.8)`;
            }
        }

        // Create correlation chart
        function createCorrelationChart(correlationData) {
            const canvas = document.getElementById('correlationChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy previous chart if exists
            if (window.correlationChart instanceof Chart) {
                window.correlationChart.destroy();
            }
            
            // Get a reference feature (first feature)
            const features = Object.keys(correlationData);
            const referenceFeature = features[0];
            
            // Get correlation values for the reference feature
            const correlationValues = features.map(feature => {
                return {
                    feature: feature,
                    correlation: correlationData[feature][referenceFeature]
                };
            });
            
            // Sort by correlation value
            correlationValues.sort((a, b) => b.correlation - a.correlation);
            
            // Create a new chart
            window.correlationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: correlationValues.map(item => item.feature),
                    datasets: [{
                        label: `Correlation with ${referenceFeature}`,
                        data: correlationValues.map(item => item.correlation),
                        backgroundColor: correlationValues.map(item => {
                            const normalized = (item.correlation + 1) / 2;
                            return getCorrelationColor(normalized);
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: `Feature Correlation with ${referenceFeature}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: -1,
                            max: 1,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Helper function to create collapsible JSON viewer
        function createJsonViewer(json) {
            const container = document.createElement('div');
            container.className = 'json-container';
            
            function renderJson(obj, container, depth = 0) {
                const type = Array.isArray(obj) ? 'array' : typeof obj;
                
                if (obj === null) {
                    const nullSpan = document.createElement('span');
                    nullSpan.className = 'json-null';
                    nullSpan.textContent = 'null';
                    container.appendChild(nullSpan);
                    return;
                }
                
                switch (type) {
                    case 'object':
                    case 'array':
                        const isArray = type === 'array';
                        const keys = Object.keys(obj);
                        
                        // Create collapsible section if not empty
                        if (keys.length > 0) {
                            const bracketSpan = document.createElement('span');
                            bracketSpan.className = 'collapsible';
                            bracketSpan.textContent = isArray ? '[' : '{';
                            container.appendChild(bracketSpan);
                            
                            const childrenDiv = document.createElement('div');
                            childrenDiv.className = 'json-children';
                            
                            // Add event listener to toggle collapse
                            bracketSpan.addEventListener('click', () => {
                                bracketSpan.classList.toggle('collapsed');
                                childrenDiv.style.display = childrenDiv.style.display === 'none' ? 'block' : 'none';
                            });
                            
                            keys.forEach((key, index) => {
                                const propertyDiv = document.createElement('div');
                                
                                if (!isArray) {
                                    // Add property key for objects
                                    const keySpan = document.createElement('span');
                                    keySpan.className = 'json-key';
                                    keySpan.textContent = `"${key}": `;
                                    propertyDiv.appendChild(keySpan);
                                }
                                
                                // Render the value
                                renderJson(obj[key], propertyDiv, depth + 1);
                                
                                // Add comma if not last property
                                if (index < keys.length - 1) {
                                    const commaSpan = document.createElement('span');
                                    commaSpan.textContent = ',';
                                    propertyDiv.appendChild(commaSpan);
                                }
                                
                                childrenDiv.appendChild(propertyDiv);
                            });
                            
                            container.appendChild(childrenDiv);
                            
                            const closingBracketSpan = document.createElement('span');
                            closingBracketSpan.textContent = isArray ? ']' : '}';
                            container.appendChild(closingBracketSpan);
                        } else {
                            // Empty object or array
                            const emptySpan = document.createElement('span');
                            emptySpan.textContent = isArray ? '[]' : '{}';
                            container.appendChild(emptySpan);
                        }
                        break;
                    
                    case 'string':
                        const stringSpan = document.createElement('span');
                        stringSpan.className = 'json-string';
                        stringSpan.textContent = `"${obj}"`;
                        container.appendChild(stringSpan);
                        break;
                    
                    case 'number':
                        const numberSpan = document.createElement('span');
                        numberSpan.className = 'json-number';
                        numberSpan.textContent = obj;
                        container.appendChild(numberSpan);
                        break;
                    
                    case 'boolean':
                        const booleanSpan = document.createElement('span');
                        booleanSpan.className = 'json-boolean';
                        booleanSpan.textContent = obj;
                        container.appendChild(booleanSpan);
                        break;
                    
                    default:
                        const valueSpan = document.createElement('span');
                        valueSpan.className = 'json-value';
                        valueSpan.textContent = String(obj);
                        container.appendChild(valueSpan);
                }
            }
            
            renderJson(json, container);
            return container;
        }

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', function() {
            if (!currentEndpoint) return;
            
            // Get the current data
            fetch(`${BASE_URL}/${currentEndpoint}/`)
                .then(response => response.json())
                .then(data => {
                    // Create a blob and download link
                    const jsonStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentEndpoint}-data.json`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                })
                .catch(error => {
                    console.error('Error exporting data:', error);
                    alert('Error exporting data. Please try again.');
                });
        });
    </script>
</body>
</html>